{% extends "base.html" %}
{% block title %}OpenTransLive - Studio Control{% endblock %}

{% block content %}
<div class="flex flex-col h-screen bg-gray-900 text-gray-100 font-sans">
  <!-- Top Bar -->
  <header class="flex items-center px-6 py-3 bg-gray-800 border-b border-gray-700 shadow-md gap-4">
    <div class="flex items-center gap-4">
      <h1 class="text-xl font-bold tracking-wider text-red-500 uppercase">
        <span class="inline-block w-3 h-3 mr-2 bg-red-500 rounded-full animate-pulse"></span>
        Live Studio
      </h1>
      <div class="px-3 py-1 text-xs font-mono bg-gray-900 rounded border border-gray-700 text-gray-400">
        SID: {{ sid }}
      </div>
    </div>
    <span class="flex items-center gap-1">
      <span id="status-indicator" class="inline-block w-3 h-3 rounded-full bg-gray-400"></span>
      <span id="status-text">Connecting...</span>
    </span>
    <!-- Mic Toggle Button -->
    <button id="mic-toggle-btn" title="Toggle microphone" class="mic-btn mic-off mx-auto" aria-pressed="false">
      <!-- Mic ON icon -->
      <iconify-icon id="mic-icon-on" icon="mdi:microphone" width="20" height="20" style="display:none"></iconify-icon>
      <!-- Mic OFF icon -->
      <iconify-icon id="mic-icon-off" icon="mdi:microphone-off" width="20" height="20"></iconify-icon>
      <span id="mic-label">MIC OFF</span>
    </button>

    <div class="flex items-center gap-2 bg-gray-900 p-1 rounded-lg border border-gray-700 ms-auto">
      <span class="pl-2 text-xs text-gray-500 uppercase font-bold">SECRET_KEY</span>
      <div class="relative group">
        <input id="user-secret-key" type="text" value="{{ user_secret_key }}"
          class="copyable-input w-24 bg-gray-800 border-none text-sm text-blue-400 px-3 py-1 rounded focus:ring-1 focus:ring-blue-500 outline-none cursor-pointer readonly font-mono"
          readonly>
        <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
          <iconify-icon icon="mdi:content-copy" class="text-gray-500" width="16" height="16"></iconify-icon>
        </div>
      </div>
    </div>
    <div class="flex items-center gap-2 bg-gray-900 p-1 rounded-lg border border-gray-700">
      <span class="pl-2 text-xs text-gray-500 uppercase font-bold">Viewer Link</span>
      <div class="relative group">
        <input id="viewer-url" type="text" value=""
          class="copyable-input w-max bg-gray-800 border-none text-sm text-blue-400 px-3 py-1 rounded focus:ring-1 focus:ring-blue-500 outline-none cursor-pointer readonly"
          readonly>
        <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
          <iconify-icon icon="mdi:content-copy" class="text-gray-500" width="16" height="16"></iconify-icon>
        </div>
      </div>
    </div>
  </header>

  <div class="flex-1 relative w-full h-full bg-white">
    <iframe src="/rt/{{ sid }}" class="w-full h-full border-0" allow="autoplay; fullscreen"></iframe>
  </div>
</div>
{% endblock %}

{% block scripts %}
<style>
  .mic-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 6px 14px;
    border-radius: 9999px;
    border: 2px solid transparent;
    font-size: 0.7rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    cursor: pointer;
    transition: background 0.2s, border-color 0.2s, box-shadow 0.2s, transform 0.1s;
    user-select: none;
    outline: none;
  }

  .mic-btn:active {
    transform: scale(0.95);
  }

  /* OFF state */
  .mic-off {
    background: #1f2937;
    border-color: #374151;
    color: #9ca3af;
  }

  .mic-off:hover {
    background: #374151;
    border-color: #6b7280;
    color: #e5e7eb;
  }

  /* ON / recording state */
  .mic-on {
    background: #7f1d1d;
    border-color: #ef4444;
    color: #fca5a5;
    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
    animation: mic-pulse 1.6s ease-in-out infinite;
  }

  .mic-on:hover {
    background: #991b1b;
  }

  @keyframes mic-pulse {
    0% {
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
    }

    50% {
      box-shadow: 0 0 0 8px rgba(239, 68, 68, 0);
    }

    100% {
      box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
    }
  }

  /* Stopping / busy state */
  .mic-busy {
    background: #1f2937;
    border-color: #4b5563;
    color: #6b7280;
    cursor: not-allowed;
    animation: none;
  }
</style>
<script>
  const sid = "{{ sid }}"
  const sessionId = "{{ sid }}"
  const user_secret_key = "{{ user_secret_key }}"

  // ── Mic toggle ───────────────────────────────────────────────────────────

  const iconOn = document.getElementById('mic-icon-on')
  const iconOff = document.getElementById('mic-icon-off')
  const micLabel = document.getElementById('mic-label')
  const micBtn = document.getElementById('mic-toggle-btn')
  let recording = false

  function setMicState(state) {
    // state: 'off' | 'on' | 'busy'
    micBtn.className = 'mic-btn mic-' + state
    micBtn.disabled = (state === 'busy')
    micBtn.setAttribute('aria-pressed', state === 'on' ? 'true' : 'false')

    if (state === 'on') {
      iconOn.style.display = ''
      iconOff.style.display = 'none'
      micLabel.textContent = 'MIC ON'
      micBtn.title = 'Stop microphone'
    } else if (state === 'busy') {
      iconOn.style.display = 'none'
      iconOff.style.display = ''
      micLabel.textContent = 'STOPPING…'
      micBtn.title = 'Please wait…'
    } else {
      iconOn.style.display = 'none'
      iconOff.style.display = ''
      micLabel.textContent = 'MIC OFF'
      micBtn.title = 'Start microphone'
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    // ── Set full viewer URL ───────────────────────────────────────────────────
    document.getElementById('viewer-url').value = window.location.origin + '/rt/' + sid

    // ── Copyable inputs ──────────────────────────────────────────────────────
    const inputs = Array.from(document.getElementsByClassName('copyable-input'))
    inputs.forEach(element => {
      element.addEventListener("click", async function () {
        try {
          await navigator.clipboard.writeText(element.value)
        } catch {
          element.select()
          document.execCommand('copy')
        }
        const origBg = element.style.backgroundColor
        element.style.backgroundColor = 'rgb(34, 197, 94)'
        setTimeout(() => { element.style.backgroundColor = origBg }, 200)
      })
    })
    micBtn.addEventListener('click', async () => {
      if (recording) {
        setMicState('busy')
        await stopSession()
        recording = false
        setMicState('off')
      } else {
        setMicState('busy')
        await startSession()
        recording = true
        setMicState('on')
      }
    })
  })
</script>
<script src="/static/js/realtime.js?v={{ timestamp }}"></script>
{% endblock %}