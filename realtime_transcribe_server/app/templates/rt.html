{% extends "base.html" %} {% block content %}
<div class="flex flex-col h-svh">
  <div id="data-content" class="p-2 break-all whitespace-pre-wrap flex-grow-1 overflow-y-auto">
  </div>
  <div id="connection-status" class="text-sm mt-auto ms-auto p-2 flex items-center gap-2">
    <span>Language</span>
    <select
      id="language-select"
      class="inline-block border-2 border-dark rounded-md p-1"
    ></select>
    <span
      id="status-indicator"
      class="inline-block w-3 h-3 rounded-full bg-gray-400"
    ></span>
    <span id="status-text">Connecting...</span>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  let transcriptionsData = {{ data | tojson(indent = 2) }};
  let lastSubtitle = null;
  const statusIndicator = document.getElementById('status-indicator');
  const statusText = document.getElementById('status-text');

  function getLanguages() {
    if (transcriptionsData.transcriptions) {
      const languages = Object.keys(transcriptionsData.transcriptions[0].result.translated);
      const languageSelect = document.getElementById('language-select');
      languages.forEach(language => {
        if (languageSelect.querySelector(`option[value="${language}"]`)) {
          return;
        }
        const option = document.createElement('option');
        option.value = language;
        option.textContent = language;
        languageSelect.appendChild(option);
      });
    }
  }

  function refreshView() {
    if (transcriptionsData.transcriptions?.length > 0) {
      const dataContent = document.getElementById('data-content');
      dataContent.textContent = '';
      transcriptionsData.transcriptions.slice(-100).forEach(subtitle => {
        dataContent.textContent += '\n' + subtitle.result.translated[document.getElementById('language-select').value];
      });
      dataContent.scrollTop = dataContent.scrollHeight;
    }
  }

  document.getElementById('language-select').addEventListener('change', function() {
    refreshView();
  });

  document.addEventListener('DOMContentLoaded', function() {
      getLanguages();
      refreshView();

      // Connect to SSE endpoint
      const eventSource = new EventSource('/api/sse/{{ id }}');

      eventSource.onopen = function() {
          statusIndicator.className = 'inline-block w-3 h-3 rounded-full bg-green-500';
          statusText.textContent = 'Connected';
          console.log('SSE connection opened');
      };

      eventSource.onerror = function(event) {
          statusIndicator.className = 'inline-block w-3 h-3 rounded-full bg-red-500';
          statusText.textContent = 'Connection error';
          console.error('SSE connection error:', event);
      };

      eventSource.onmessage = function(event) {
          try {
              const data = JSON.parse(event.data);
              console.log('SSE message received:', data);

              // Skip keepalive messages
              if (data.type === 'keepalive') {
                  return;
              }

              // Handle connection message
              if (data.type === 'connected') {
                  statusText.textContent = 'Connected to session: ' + data.id;
                  return;
              }
              if (data.type === 'update') {
                  transcriptionsData = data.data;
                  getLanguages();
                  refreshView();
              }
          } catch (error) {
              console.error('Error parsing SSE data:', error);
          }
      };

      // Cleanup on page unload
      window.addEventListener('beforeunload', function() {
          eventSource.close();
      });
  });
</script>
{% endblock %}
